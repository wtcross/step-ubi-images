name: Build and Scan Container Images

on:
  pull_request:
    branches: [main]
    paths:
      - 'step-builder/**'
      - 'step-ca/**'
      - 'step-cli/**'
      - 'step-kms-plugin/**'
      - 'versions.json'
      - '.github/workflows/build-images.yml'
  push:
    branches: [main]
    paths:
      - 'step-builder/**'
      - 'step-ca/**'
      - 'step-cli/**'
      - 'step-kms-plugin/**'
      - 'versions.json'
      - '.github/workflows/build-images.yml'
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      step-builder: ${{ steps.changes.outputs.step-builder }}
      step-ca: ${{ steps.changes.outputs.step-ca }}
      step-cli: ${{ steps.changes.outputs.step-cli }}
      step-kms-plugin: ${{ steps.changes.outputs.step-kms-plugin }}
      versions: ${{ steps.versions.outputs.json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        if: github.event_name != 'schedule' && github.event_name != 'workflow_dispatch'
        with:
          filters: |
            step-builder:
              - 'step-builder/**'
              - 'versions.json'
            step-ca:
              - 'step-builder/**'
              - 'step-ca/**'
              - 'versions.json'
            step-cli:
              - 'step-cli/**'
              - 'versions.json'
            step-kms-plugin:
              - 'step-builder/**'
              - 'step-kms-plugin/**'
              - 'versions.json'

      - name: Read versions
        id: versions
        run: |
          echo "json=$(cat versions.json | jq -c .)" >> $GITHUB_OUTPUT

      - name: Set all outputs for scheduled/manual runs
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "step-builder=true" >> $GITHUB_OUTPUT
          echo "step-ca=true" >> $GITHUB_OUTPUT
          echo "step-cli=true" >> $GITHUB_OUTPUT
          echo "step-kms-plugin=true" >> $GITHUB_OUTPUT

  build-step-builder:
    needs: detect-changes
    if: needs.detect-changes.outputs.step-builder == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      image: ${{ steps.prep.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Extract versions and set tags
        id: prep
        run: |
          M4_VERSION=$(echo '${{ needs.detect-changes.outputs.versions }}' | jq -r '.m4')
          FLEX_VERSION=$(echo '${{ needs.detect-changes.outputs.versions }}' | jq -r '.flex')
          MESON_VERSION=$(echo '${{ needs.detect-changes.outputs.versions }}' | jq -r '.meson')
          PCSC_LITE_VERSION=$(echo '${{ needs.detect-changes.outputs.versions }}' | jq -r '."pcsc-lite"')
          echo "m4=${M4_VERSION}" >> $GITHUB_OUTPUT
          echo "flex=${FLEX_VERSION}" >> $GITHUB_OUTPUT
          echo "meson=${MESON_VERSION}" >> $GITHUB_OUTPUT
          echo "pcsc-lite=${PCSC_LITE_VERSION}" >> $GITHUB_OUTPUT

          IMAGE_BASE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-builder"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "primary_tag=pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "tags=${IMAGE_BASE}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "image=${IMAGE_BASE}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "primary_tag=latest" >> $GITHUB_OUTPUT
            echo "tags=${IMAGE_BASE}:m4-${M4_VERSION}-flex-${FLEX_VERSION}-meson-${MESON_VERSION}-pcsc-${PCSC_LITE_VERSION} ${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
            echo "image=${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        run: |
          TAG_ARGS=""
          for tag in ${{ steps.prep.outputs.tags }}; do
            TAG_ARGS="${TAG_ARGS} --tag ${tag}"
          done

          podman build \
            --build-arg M4_VERSION=${{ steps.prep.outputs.m4 }} \
            --build-arg FLEX_VERSION=${{ steps.prep.outputs.flex }} \
            --build-arg MESON_VERSION=${{ steps.prep.outputs.meson }} \
            --build-arg PCSC_LITE_VERSION=${{ steps.prep.outputs.pcsc-lite }} \
            ${TAG_ARGS} \
            -f ./step-builder/ubi10.Containerfile \
            ./step-builder

      - name: Push image
        if: github.event_name != 'pull_request'
        run: |
          for tag in ${{ steps.prep.outputs.tags }}; do
            podman push "${tag}"
          done

      - name: Sign images with cosign
        if: github.event_name != 'pull_request'
        env:
          COSIGN_YES: "true"
        run: |
          for tag in ${{ steps.prep.outputs.tags }}; do
            echo "Signing ${tag}"
            cosign sign "${tag}"
          done

  build-step-cli:
    needs: detect-changes
    if: needs.detect-changes.outputs.step-cli == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      security-events: write
    outputs:
      image: ${{ steps.prep.outputs.image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Extract versions and set tags
        id: prep
        run: |
          STEP_CLI_VERSION=$(echo '${{ needs.detect-changes.outputs.versions }}' | jq -r '."step-cli"')
          echo "step-cli=${STEP_CLI_VERSION}" >> $GITHUB_OUTPUT

          IMAGE_BASE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-cli"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "primary_tag=pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "tags=${IMAGE_BASE}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "image=${IMAGE_BASE}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "primary_tag=v${STEP_CLI_VERSION}" >> $GITHUB_OUTPUT
            echo "tags=${IMAGE_BASE}:v${STEP_CLI_VERSION} ${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
            echo "image=${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        run: |
          TAG_ARGS=""
          for tag in ${{ steps.prep.outputs.tags }}; do
            TAG_ARGS="${TAG_ARGS} --tag ${tag}"
          done

          podman build \
            --build-arg STEP_CLI_VERSION=${{ steps.prep.outputs.step-cli }} \
            ${TAG_ARGS} \
            -f ./step-cli/ubi10.Containerfile \
            ./step-cli

      - name: Export image for Trivy scan
        run: |
          podman save -o step-cli-image.tar ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-cli:${{ steps.prep.outputs.primary_tag }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          input: 'step-cli-image.tar'
          format: 'sarif'
          output: 'trivy-results-step-cli.sarif'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln'
          skip-files: '/etc/yum.repos.d/*,/etc/pki/entitlement/*'

      - name: Check for critical vulnerabilities
        id: trivy-check
        run: |
          if [[ -f "trivy-results-step-cli.sarif" ]]; then
            CRITICAL_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' trivy-results-step-cli.sarif)
            echo "critical_count=${CRITICAL_COUNT}" >> $GITHUB_OUTPUT
            if [[ "$CRITICAL_COUNT" -gt 0 ]]; then
              echo "::warning::Found ${CRITICAL_COUNT} critical vulnerabilities"
            fi
          else
            echo "::warning::Trivy scan did not produce results file"
            echo "critical_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: hashFiles('trivy-results-step-cli.sarif') != ''
        with:
          sarif_file: 'trivy-results-step-cli.sarif'
          category: 'step-cli'

      - name: Push image
        if: github.event_name != 'pull_request'
        run: |
          for tag in ${{ steps.prep.outputs.tags }}; do
            podman push "${tag}"
          done

      - name: Sign images with cosign
        if: github.event_name != 'pull_request'
        env:
          COSIGN_YES: "true"
        run: |
          for tag in ${{ steps.prep.outputs.tags }}; do
            echo "Signing ${tag}"
            cosign sign "${tag}"
          done

  build-step-ca:
    needs: [detect-changes, build-step-builder, build-step-cli]
    if: always() && (needs.detect-changes.outputs.step-ca == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && (needs.build-step-builder.result == 'success' || needs.build-step-builder.result == 'skipped') && (needs.build-step-cli.result == 'success' || needs.build-step-cli.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Extract versions and set tags
        id: prep
        run: |
          STEP_CA_VERSION=$(echo '${{ needs.detect-changes.outputs.versions }}' | jq -r '."step-ca"')
          echo "step-ca=${STEP_CA_VERSION}" >> $GITHUB_OUTPUT

          IMAGE_BASE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-ca"
          BASE_BUILDER="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-builder"
          STEP_CLI="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-cli"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "primary_tag=pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "tags=${IMAGE_BASE}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "base_builder_image=${BASE_BUILDER}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "step_cli_image=${STEP_CLI}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "primary_tag=v${STEP_CA_VERSION}" >> $GITHUB_OUTPUT
            echo "tags=${IMAGE_BASE}:v${STEP_CA_VERSION} ${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
            echo "base_builder_image=${BASE_BUILDER}:latest" >> $GITHUB_OUTPUT
            echo "step_cli_image=${STEP_CLI}:latest" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        run: |
          TAG_ARGS=""
          for tag in ${{ steps.prep.outputs.tags }}; do
            TAG_ARGS="${TAG_ARGS} --tag ${tag}"
          done

          podman build \
            --build-arg BASE_BUILDER_IMAGE=${{ steps.prep.outputs.base_builder_image }} \
            --build-arg STEP_CLI_IMAGE=${{ steps.prep.outputs.step_cli_image }} \
            --build-arg STEP_CA_VERSION=${{ steps.prep.outputs.step-ca }} \
            ${TAG_ARGS} \
            -f ./step-ca/ubi10.pkcs11.Containerfile \
            ./step-ca

      - name: Export image for Trivy scan
        run: |
          podman save -o step-ca-image.tar ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-ca:${{ steps.prep.outputs.primary_tag }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          input: 'step-ca-image.tar'
          format: 'sarif'
          output: 'trivy-results-step-ca.sarif'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln'
          skip-files: '/etc/yum.repos.d/*,/etc/pki/entitlement/*'

      - name: Check for critical vulnerabilities
        id: trivy-check
        run: |
          if [[ -f "trivy-results-step-ca.sarif" ]]; then
            CRITICAL_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' trivy-results-step-ca.sarif)
            echo "critical_count=${CRITICAL_COUNT}" >> $GITHUB_OUTPUT
            if [[ "$CRITICAL_COUNT" -gt 0 ]]; then
              echo "::warning::Found ${CRITICAL_COUNT} critical vulnerabilities"
            fi
          else
            echo "::warning::Trivy scan did not produce results file"
            echo "critical_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: hashFiles('trivy-results-step-ca.sarif') != ''
        with:
          sarif_file: 'trivy-results-step-ca.sarif'
          category: 'step-ca'

      - name: Push image
        if: github.event_name != 'pull_request'
        run: |
          for tag in ${{ steps.prep.outputs.tags }}; do
            podman push "${tag}"
          done

      - name: Sign images with cosign
        if: github.event_name != 'pull_request'
        env:
          COSIGN_YES: "true"
        run: |
          for tag in ${{ steps.prep.outputs.tags }}; do
            echo "Signing ${tag}"
            cosign sign "${tag}"
          done

  build-step-kms-plugin:
    needs: [detect-changes, build-step-builder, build-step-cli]
    if: always() && (needs.detect-changes.outputs.step-kms-plugin == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && (needs.build-step-builder.result == 'success' || needs.build-step-builder.result == 'skipped') && (needs.build-step-cli.result == 'success' || needs.build-step-cli.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Extract versions and set tags
        id: prep
        run: |
          STEP_KMS_PLUGIN_TAG=$(echo '${{ needs.detect-changes.outputs.versions }}' | jq -r '."step-kms-plugin"')
          echo "step-kms-plugin=${STEP_KMS_PLUGIN_TAG}" >> $GITHUB_OUTPUT

          IMAGE_BASE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-kms-plugin"
          BASE_BUILDER="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-builder"
          STEP_CLI="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-cli"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "primary_tag=pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "tags=${IMAGE_BASE}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "base_builder_image=${BASE_BUILDER}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "step_cli_image=${STEP_CLI}:pr-${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "primary_tag=${STEP_KMS_PLUGIN_TAG}" >> $GITHUB_OUTPUT
            echo "tags=${IMAGE_BASE}:${STEP_KMS_PLUGIN_TAG} ${IMAGE_BASE}:latest" >> $GITHUB_OUTPUT
            echo "base_builder_image=${BASE_BUILDER}:latest" >> $GITHUB_OUTPUT
            echo "step_cli_image=${STEP_CLI}:latest" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        run: |
          TAG_ARGS=""
          for tag in ${{ steps.prep.outputs.tags }}; do
            TAG_ARGS="${TAG_ARGS} --tag ${tag}"
          done

          podman build \
            --build-arg BASE_BUILDER_IMAGE=${{ steps.prep.outputs.base_builder_image }} \
            --build-arg STEP_CLI_IMAGE=${{ steps.prep.outputs.step_cli_image }} \
            --build-arg STEP_KMS_PLUGIN_TAG=${{ steps.prep.outputs.step-kms-plugin }} \
            ${TAG_ARGS} \
            -f ./step-kms-plugin/ubi10.pkcs11.Containerfile \
            ./step-kms-plugin

      - name: Export image for Trivy scan
        run: |
          podman save -o step-kms-plugin-image.tar ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/step-kms-plugin:${{ steps.prep.outputs.primary_tag }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          input: 'step-kms-plugin-image.tar'
          format: 'sarif'
          output: 'trivy-results-step-kms-plugin.sarif'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln'
          skip-files: '/etc/yum.repos.d/*,/etc/pki/entitlement/*'

      - name: Check for critical vulnerabilities
        id: trivy-check
        run: |
          if [[ -f "trivy-results-step-kms-plugin.sarif" ]]; then
            CRITICAL_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' trivy-results-step-kms-plugin.sarif)
            echo "critical_count=${CRITICAL_COUNT}" >> $GITHUB_OUTPUT
            if [[ "$CRITICAL_COUNT" -gt 0 ]]; then
              echo "::warning::Found ${CRITICAL_COUNT} critical vulnerabilities"
            fi
          else
            echo "::warning::Trivy scan did not produce results file"
            echo "critical_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: hashFiles('trivy-results-step-kms-plugin.sarif') != ''
        with:
          sarif_file: 'trivy-results-step-kms-plugin.sarif'
          category: 'step-kms-plugin'

      - name: Push image
        if: github.event_name != 'pull_request'
        run: |
          for tag in ${{ steps.prep.outputs.tags }}; do
            podman push "${tag}"
          done

      - name: Sign images with cosign
        if: github.event_name != 'pull_request'
        env:
          COSIGN_YES: "true"
        run: |
          for tag in ${{ steps.prep.outputs.tags }}; do
            echo "Signing ${tag}"
            cosign sign "${tag}"
          done
